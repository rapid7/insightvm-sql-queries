WITH asset_with_group AS (
SELECT da.ip_address,da.host_name,da.sites,dag.asset_group_id,da.asset_id
FROM dim_asset da
JOIN dim_asset_group_asset daga ON da.asset_id=daga.asset_id
JOIN dim_asset_group dag ON daga.asset_group_id=dag.asset_group_id
)

SELECT
   da.ip_address AS "IP Address",
   da.host_name AS "Host Name",
   CASE
      WHEN dve.scope_id = 'G' THEN 'All instances across all Assets'
      WHEN dve.scope_id = 'D' THEN 'All instances on asset on Asset "' || COALESCE(da.host_name, da.ip_address) ||  ' "'
      WHEN dve.scope_id = 'I' THEN 'Specific instance on Asset "' || da.host_name || 'or' || da.ip_address || ' "'
      WHEN dve.scope_id = 'S' THEN 'All instances on this Site "' || ds.name ||  ' "'
      WHEN dve.scope_id = 'P' THEN 'All instances on this Asset Group "' || dag.name ||  ' "'
   END AS exceptionscope, 
   COALESCE(dve.additional_comments,'') AS "Additional Comments", 
   dve.submitted_date AS "Submitted Date", 
   dve.submitted_by AS "Submitted By",
   dve.review_date AS "Review Date", 
   dve.reviewed_by AS "Reviewed By", 
   dve.review_comment AS "Review Comment", 
   dve.expiration_date AS "Expiration Date", 
   des.description AS Status, 
   der.description AS Reason,
   dv.title AS "Vulnerability Title", 
   dv.nexpose_id AS Vulnerability

FROM asset_with_group da 

   JOIN dim_vulnerability_exception dve ON da.asset_group_id=dve.group_id
   LEFT OUTER JOIN dim_site ds ON dve.site_id=ds.site_id
   JOIN dim_exception_status des on des.status_id = dve.status_id
   JOIN dim_exception_reason der on der.reason_id = dve.reason_id
   JOIN dim_exception_scope descope on descope.scope_id = dve.scope_id
   JOIN dim_vulnerability dv on dv.vulnerability_id = dve.vulnerability_id
   LEFT JOIN dim_asset_group dag ON dve.group_id=dag.asset_group_id

WHERE dve.expiration_date >= current_date or dve.expiration_date is null
